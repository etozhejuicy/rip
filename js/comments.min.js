var category="";var type="";var section="";var reply_author_id="";var shareBlockTimer;function setEventOnCommentAdd(){$("button[comment-submit-add]").off("click").on("click",function(){category=$("#comment-category").attr("data-title");type=$("#comment-type").attr("data-title");section=$("#comment-section").attr("data-title");var current_object=$(this);var current_category=$('#comment-block-add input[name="category"]').val();var current_text=$(this).parent().find('[name="text"]').val();var current_level=$('[name="level"]').val();var current_left_id=$('[name="left_id"]').val();var current_parent_id=$('[name="parent_id"]').val();var data={section:section,category:current_category,text:current_text,level:current_level,left_id:current_left_id,parent_id:current_parent_id,reply_author_id:reply_author_id};data[TOKEN]=formKey;if(current_category==""||current_text==""){createNotice("Вы заполнили не все поля","error");return}controlLoadIcon("create");$.ajax({url:"/replies/add",type:"POST",data:data,success:function(data){if(data.id==false){if(data.action=="login"){loginPopup();return}}$.ajax({url:"/replies/getSingle/"+data.id,type:"GET",success:function(cmt){if(type=="normal"&&data.moderation==1){if(current_parent_id!=""&&current_parent_id!=undefined){var current_next_blocks=$('[data-id="'+current_parent_id+'"]').nextAll();var flag=true;var flag_added=false;current_next_blocks.map(function(indx,element){if($(element).attr("data-level")<=current_level*1-1&&flag){$(element).before(cmt);flag=false;flag_added=true}});if(!flag_added){$("#comments-list-in").append(cmt)}}else{if($("#comments-list-in").attr("id")!=undefined){$("#comments-list-in").append(cmt)}else{$("#comments-list").append(cmt)}}controlLoadIcon("destroy");$("#comment-not-enough").remove()}else{controlLoadIcon("destroy");createNotice("Комментарий успешно добавлен, но будет отображен после проверки модератора")}refreshAllCommentEvents()}})}});$(this).parent().find('[name="text"]').val("");$(".comments-form-add").fadeOut(200,function(){$(this).remove()})})}function setEventOnCommentReply(){$("a[data-reply-answet]").off("click").on("click",function(){let place_for_form=$(this).parents(".c-item");if(place_for_form.find(".comments-form-add").length!=0)return;$(".comments-form-add").remove();let bbcodes=$(".news-comment-form").find(".bbcodes");if(bbcodes.length!=0)bbcodes='<div class="bbcodes">'+bbcodes.html()+"</div>";else bbcodes="";let smiles=$(".news-comment-form").find(".smiles");if(smiles.length!=0){$(".smiles .smile-list").hide();smiles='<div class="smiles">'+smiles.html()+"</div>"}else smiles="";$(`<div class="comments-form-add">\n            <textarea class="comments-textarea" name="text" id="second-comment-textarea" placeholder="Ваш комментарий..."></textarea>\n            ${bbcodes}\n            <button name="sbm" style="float: right;" comment-submit-cancel onclick="$(this).parent().remove()"><i class="fa fa-times"></i></button>\n            <button name="sbm" style="float: right;" comment-submit-add><i class="fa fa-location-arrow"></i> Отправить</button>\n            <div class="clb"></div>\n            ${smiles}\n            <input type="hidden" name="parent_id" value="">\n            <input type="hidden" name="level" value="0">\n            <div class="clb"></div>\n        </div>`).fadeOut(0).fadeIn(200,function(){if(bbcodes!=""){publicBBcodes(".comments-form-add .bbcodes > a","id","#second-comment-textarea","bb","[","]","yes");publicBBcodes(".comments-form-add .smile-list .smiles-panel .tabs-content .content a","data-tag","#second-comment-textarea","bb","","")}}).appendTo(place_for_form);let current_id=place_for_form.attr("data-id"),current_level=place_for_form.attr("data-level");if(current_level==""||current_level==undefined)current_level=0;if(current_id==""||current_id==undefined)current_id="";let form=place_for_form.find(".comments-form-add");form.find('input[name="level"]').val(current_level*1+1);form.find('input[name="parent_id"]').val(current_id);refreshAllCommentEvents()})}function setEventOnCommentRemove(){$("[data-reply-remove]").off("click.commentRemove").on("click.commentRemove",function(){let current_id=$(this).attr("data-reply-remove"),current_parent=$(`#comment-block${current_id}`),current_level=current_parent.attr("data-level"),flag=true,current_next_blocks=current_parent.nextAll(),current_children=current_next_blocks.map(function(index,element){if($(element).attr("data-level")>current_level&&flag)return $(element);else flag=false});Core.Ajax.get("/replies/removeForm",resp=>{let popup=Core.Popup.create("Удаление комментария",resp.data.html,[{element:"a",prop:{href:"javascript:void(0)",class:"popup-button-sim",text:"Удалить",onclick:"$('.popup-content form').submit()"}},{element:"a",prop:{href:"javascript:void(0)",class:"popup-button-sim",text:"Отменить",onclick:"Core.Popup.destroy()"}}]);popup.find('input[name="reason"]').focus();popup.find("form").off("submit").on("submit",function(){Core.Ajax.post("/replies/remove",{id:current_id,reason:popup.find('input[name="reason"]').val()},resp=>{createNotice(resp.message);if(resp.status=="success"){Core.Popup.destroy(popup);current_parent.fadeOut(150,function(){$(this).remove()});current_children.each(function(){$(this).fadeOut(150,function(){$(this).remove()})})}})})})})}function setEventOnCommentReport(){$("[data-reply-report]").off("click").on("click",function(){var current_object=$(this);var current_id=current_object.attr("data-reply-report");if(current_id=="")return;controlLoadIcon("create");$.ajax({url:base_url+"replies/report",type:"POST",data:{reply_id:current_id,key:formKey},success:function(){controlLoadIcon("destroy");current_object.fadeOut(200,function(){current_object.remove()});createNotice("Жалоба отправлена")}})})}function setEventOnCommentBan(){$("[data-reply-ban]").off("click").on("click",function(){var $object=$(this);var $parent=$object.parent();var $parents=$object.parents(".tooltipe");var current_id=$object.attr("data-reply-ban");var current_ban_time=$parent.find('input[type="text"]').val();var current_comments_remove=$parent.find('input[type="checkbox"]').is(":checked");if(current_id=="")return;controlLoadIcon("create");$.ajax({url:base_url+"replies/ban",type:"POST",data:{reply_id:current_id,ban_time:current_ban_time,comments_remove:current_comments_remove},success:function(data){controlLoadIcon("destroy");$parents.fadeOut(200,function(){$object.remove()});createNotice("Пользователь забанен")}})})}function setEventOnCommentRating(){$("[data-reply-rating]").off("click").on("click",function(){var current_object=$(this);var current_controll_parent=current_object.parents(".c-item");var data={reply_id:current_object.attr("data-reply-rating-id"),type:current_object.attr("data-reply-rating")};data[TOKEN]=formKey;controlLoadIcon("create");$.ajax({url:base_url+"replies/rating",type:"POST",data:data,success:function(data){controlLoadIcon("destroy");current_object.parent().find("[data-reply-rating]").fadeOut(200,function(){if(data=="")return;current_controll_parent.find(".comment-rating").html('<i class="fa fa-heart"></i> '+data)})}})})}function setEventOnCommentEdit(){$("[data-reply-edit]").off("click").on("click",function(){var current_object=$(this);var current_id=current_object.attr("data-reply-edit");var current_text_block=current_object.parent().parent().parent().find(".text");$.ajax({url:base_url+"replies/get_single_for_edit/"+current_id,type:"GET",dataType:"JSON",success:function(data){var bbcodes=$(".news-comment-form").find(".bbcodes");if(bbcodes.attr("class")!=undefined)bbcodes='<div class="bbcodes">'+bbcodes.html()+"</div>";else bbcodes="";var smiles=$(".news-comment-form").find(".smiles");if(smiles.attr("class")!=undefined){$(".smiles .smile-list").hide();smiles='<div class="smiles">'+smiles.html()+"</div>"}else smiles="";current_text_block.html('<div class="comments-form-edit">'+'<textarea class="comments-textarea" name="text" id="edit-comment-textarea" placeholder="Ваш комментарий...">'+data.message+"</textarea>"+bbcodes+'<button name="sbm" style="float: right;" comment-submit-edit><i class="fa fa-floppy-o"></i> Сохранить</button>'+'<div class="clb"></div>'+smiles+'<input type="hidden" name="level" value="0" />'+'<input type="hidden" name="left_id" value="" />'+'<input type="hidden" name="parent_id" value="" />'+'<div class="clb"></div>'+"</div>").fadeIn(200,function(){if(bbcodes!=""){publicBBcodes(".comments-form-edit .bbcodes > a","id","#edit-comment-textarea","bb","[","]","yes");publicBBcodes(".comments-form-edit .smile-list .smiles-panel .tabs-content .content a","data-tag","#edit-comment-textarea","bb","","")}});refreshAllCommentEvents();current_text_block.find("[comment-submit-edit]").click(function(){var current_text=current_text_block.find("textarea").val();var data={reply_id:current_id,text:current_text};data[TOKEN]=formKey;if(current_text=="")return;controlLoadIcon("create");$.ajax({url:base_url+"replies/edit",type:"POST",data:data,success:function(data){controlLoadIcon("destroy");current_text_block.html(data)}})})}})})}function setEventOnCommentFullForm(){$(".news-comment-form, .comments-form-add").off("click").on("click",function(){var $object=$(this);if("none"==$object.find("button").css("display")){$object.find("textarea").css({height:"120px"});$object.find("button").css({display:"block"})}})}function setEventOnCommentBanForm(){$('a[href$="#comment-ban"]').off("click").on("click",function(){var $obj=$(this);var member_id=$obj.data("id");var comment_id=$obj.data("comment-id");$.ajax({url:base_url+"replies/control_ban_form/"+member_id+"/"+comment_id,type:"GET",success:function(response){popup_show(response);setEventOnCommentBanFormSending()}});return false})}function setEventOnCommentBanFormSending(){$(".member-comments-ban-form").find('button[class="send"]').off("click").on("click",function(){var $obj=$(this);var $form=$obj.parents(".member-comments-ban-form").find("form");var reason=$form.find('[name="reason"]').val();var member_id=$form.find('[name="member_id"]').val();var comment_id=$form.find('[name="comment_id"]').val();$.ajax({url:base_url+"replies/control_ban",type:"POST",data:{member_id:member_id,comment_id:comment_id,reason:reason,key:formKey},success:function(response){if(response.status==1){history.pushState("","",window.location.pathname);window.location.replace(base_url+"forum/members/"+member_id+"/warn?content_type=post&content_id="+response.post_id)}if(response.message!=undefined)createNotice(response.message,"error")}});return false});$('[data-action="remove-posts"]').off("click").on("click",function(){$.ajax({url:"/replies/control_clean_up",type:"POST",data:{member_id:$(this).data("id"),distance:24*60*60},success:function(response){if(response.message!=undefined)createNotice(response.message,"error");if(response.status==1)location.reload()}});return false})}function setEventOnCommentSmiles(){$(".smile-image").off("click").on("click",function(){var list=$(this).parent().parent().find(".smiles .smile-list");if(list.is(":visible")){$(this).find("i").addClass("fa-smile-o").removeClass("fa-times")}else{$(this).find("i").removeClass("fa-smile-o").addClass("fa-times");list.find(".smiles-panel .tabs-content .active img").each(function(){if($(this).attr("src")===undefined)$(this).attr("src",$(this).data("src"))})}list.toggle("fast")});$(".smiles .smile-tabs a").off("click").on("click",function(){$(".smiles .smile-tabs li").removeClass("active");$(this).parent().addClass("active");$(".smiles .tabs-content .content").removeClass("active");$(".smiles .tabs-content .content#smile-cat-"+$(this).data("cat-id")).addClass("active").find("img").each(function(){if($(this).attr("src")===undefined)$(this).attr("src",$(this).data("src"))})})}function setEventOnCommentPagination(){$("#comments-list .pagination a").off("click").on("click",function(){var $object=$(this);var $parents=$object.parents(".pagination");var page=$object.attr("data-page");var per_page=$parents.attr("data-per-page");var offset=page*per_page;controlLoadIcon("create");$.ajax({url:base_url+"replies/getList/?category="+category+"&offset="+offset,type:"GET",success:function(data){$("#comments-list").html(data);controlLoadIcon("destroy");window.location="#comments-wrapper";var current_url=$("[data-page-current-section]").attr("data-page-current-section");history.pushState("","","/"+current_url+"/?page="+page+"#comments-wrapper")}})})}function setEventOnCommentIgnore(){$('a[href$="#ignore-user"]').off("click").on("click",function(){var id=$(this).data("id");if(id=="")return false;$.ajax({url:base_url+"replies/ignoreUser/"+id,type:"POST",data:{key:formKey},success:function(response){if(response.message!=undefined)createNotice(response.message,"error")}});return false})}function setEventOnCommentShare(){function shareBlockTimerFade(){$(".share-comment").fadeOut(200,function(){$(this).remove();clearInterval(shareBlockTimer)})}$('a[href$="#comment-to"]').off("click").on("click",function(){$(this).parents(".c-item").append('<div class="share-comment"><input value="https://dota2.ru/replies/to/'+$(this).data("id")+'/"></div>');$(".share-comment").off("mouseleave").on("mouseleave",function(){shareBlockTimer=setInterval(shareBlockTimerFade,1e3)}).off("mouseover").on("mouseover",function(){clearInterval(shareBlockTimer);$(this).find("input").select()});return false})}function setEventOnCommentCloseOtherForm(){$("[data-main-form]").off("click").on("click",function(){$(".comments-form-add").fadeOut(200,function(){$(this).remove()})})}function refreshAllCommentEvents(){setEventOnCommentCloseOtherForm();setEventOnCommentPagination();setEventOnCommentAdd();setEventOnCommentReply();setEventOnRemoveAction();setEventOnCommentRemove();setEventOnCommentReport();setEventOnCommentBan();setEventOnCommentRating();setEventOnCommentEdit();setEventOnCommentFullForm();setEventOnCommentBanForm();setEventOnCommentBanFormSending();setEventOnCommentSmiles();setEventOnCommentIgnore();setEventOnCommentShare();publicBBcodes(".news-comment-form .bbcodes > a","id","#comment-textarea","bb","[","]","yes");publicBBcodes(".news-comment-form .smile-list .smiles-panel .tabs-content .content a","data-tag","#comment-textarea","bb","","")}function commentsInit(){category=$("#comment-category").attr("data-title");type=$("#comment-type").attr("data-title");section=$("#comment-section").attr("data-title");reply_author_id=$("#comment-reply-author-id").data("id");refreshAllCommentEvents()}$(document).ready(function(){commentsInit()});