var Topic={_VERSION:"1.1.10",_LOGGER:null,_post_id:null,id:null,title:null,is_opened:!0,user_id:null,forum_id:null,poll_multiple:!1,link:null,pages:1,current_page:1,last_post_id:null,first_post_id:null,discussion_open:!0,post_counter_enabled:!0,show_signature_request_processing:!1,expandLikes:function(postId){$("#post-likes-content-hidden-"+postId).show(),$("#post-likes-expand-"+postId).hide()},addDOMPost:function(data){if(void 0!==data.html)return this._LOGGER.debug("[post] addDOMPost Server returned HTML"),Topic.getLastPost().after(Base64.decode(data.html)),app.checkTime(),void(Topic.post_counter_enabled&&(postsCount=parseInt($(".user-block-"+Utils.user_id+" .uposts-count > dd:last-child").html()),$(".user-block-"+Utils.user_id+" .uposts-count > dd:last-child").html(postsCount+1)));console.error("[post] Topic doesn't support js parse type! Response is: "+JSON.stringify(data))},getLastPost:function(){return $("#message-list").find("li.message").last()},initLogger:function(){this._LOGGER=Logger.get("Topic")},init:function(){this.initLogger(),this._LOGGER.debug("[Topic] Version "+this._VERSION),this.calculateIframeSize()},calculateIframeSize:function(){$(window).width()<768&&$("iframe").each(function(){var $iframe=$(this);$iframe.removeAttr("width"),$iframe.removeAttr("height"),$iframe.css("width","100%"),$iframe.css("max-width","640px"),$iframe.css("height",$iframe.width()/1.78)})},hideSignature:function(userId){var hideBtn=$(".hide-signature-"+userId),showBtn=$(".show-signature-"+userId),block=$(".signature-user-"+userId),blockShow=$(".signature-user-show-"+userId);hideBtn.button("loading"),requestHandler.ajaxRequest("/api/user/hideUserSignature",{user_id:userId},function(response){switch(hideBtn.button("reset"),response.status){case"success":case"already":hideBtn.hide(),showBtn.show(),block.hide(),blockShow.show(),Utils.notify("Подпись данного пользователя будет скрыта","success",3500);break;case"invalidUser":Utils.notify("Некорректный пользователь","warning",6e3);break;default:Utils.notify("Произошла неизвестная ошибка","danger")}})},showSignature:function(userId){var hideBtn=$(".hide-signature-"+userId),showBtn=$(".show-signature-"+userId),block=$(".signature-user-"+userId),blockShow=$(".signature-user-show-"+userId);showBtn.button("loading"),requestHandler.ajaxRequest("/api/user/showUserSignature",{user_id:userId},function(response){switch(showBtn.button("reset"),response.status){case"success":case"already":showBtn.hide(),hideBtn.show(),blockShow.hide(),block.show(),Utils.notify("Подпись данного пользователя будет показана","success",3500);break;case"invalidUser":Utils.notify("Некорректный пользователь","warning",6e3);break;default:Utils.notify("Произошла неизвестная ошибка","danger")}})},showSignatureOnce:function(userId){var block=$(".signature-user-"+userId);Topic.show_signature_request_processing||(Topic.show_signature_request_processing=!0,requestHandler.ajaxRequest("/api/user/getUserSignature",{user_id:userId},function(response){switch(Topic.show_signature_request_processing=!1,response.status){case"success":block.html(Base64.decode(response.signature));break;case"invalidUser":Utils.notify("Некорректный пользователь","warning",4e3);break;default:Utils.notify("Произошла неизвестная ошибка","danger")}}))},showPost:function(id){var obj=$("#post-"+id);obj.find("blockquote").first().removeClass("hidden"),obj.find(".ignored-block").hide(),obj.find(".avatarHolder").show(),obj.find(".postDataHolder").show(),obj.find(".messageContent").css("min-height","85px"),obj.find(".edit-btn-block").show(),obj.removeClass("ignored")},htmlDecode:function(input){var e=document.createElement("div");return e.innerHTML=input,0===e.childNodes.length?"":e.childNodes[0].nodeValue},changeTitleModal:function(){$("#changeTitleModal").modal("show"),$("#newTopicTitle").val(Topic.htmlDecode($("#topicTitle").html())),$("#newTopicTitle").focus()},changeTitle:function(){var mainControl=$("#changeTopicTitleBtn"),title=$("#newTopicTitle").val();if(!title.trim().length)return Utils.notify("Введите название темы","warning",3e3);mainControl.button("loading"),requestHandler.ajaxRequest("/api/forum/changeTopicTitle",{title:title,tid:parseInt(Topic.id)},function(response){switch(mainControl.button("reset"),response.status){case"success":$("#topicTitle").html(title.trim()),$("#changeTitleModal").modal("hide"),Utils.notify("Название успешно изменено","success",3500);break;case"invalidTopic":Utils.notify("Некорректная тема<br>Возможно она была закрыта или удалена","warning",6e3);break;case"titleLength":Utils.notify("Превышена длина названия","warning",6e3);break;default:Utils.notify("Произошла неизвестная ошибка","danger")}})},unignoreUser:function(uid,pid){var mainControl=$("#unignore-"+pid+"-btn"),ignoreBtn=$("#ignore-"+pid+"-btn");requestHandler.ajaxRequest("/api/user/unignore",{uid:uid},function(response){switch(mainControl.button("reset"),response.status){case"success":mainControl.hide(),ignoreBtn.fadeIn(),Utils.notify("Пользователь больше не игнорируется","success",3500);break;case"already":mainControl.hide(),ignoreBtn.fadeIn(),Utils.notify("Пользователь не находится в игнорлисте","warning");break;default:Utils.notify("Произошла неизвестная ошибка","danger")}})},ignoreUser:function(uid,pid){var mainControl=$("#unignore-"+pid+"-btn"),ignoreBtn=$("#ignore-"+pid+"-btn");requestHandler.ajaxRequest("/api/user/ignore",{uid:uid},function(response){switch(mainControl.button("reset"),response.status){case"success":ignoreBtn.hide(),mainControl.fadeIn(),Utils.notify("Теперь вы игнорируете данного пользователя","success",3500);break;case"self":Utils.notify("Нельзя игнорировать самого себя","warning");break;case"already":ignoreBtn.hide(),mainControl.fadeIn(),Utils.notify("Пользователь уже в игнорлисте","warning");break;default:Utils.notify("Произошла неизвестная ошибка","danger")}})},loadPollResults:function(container,showModal,toggleBlock){container=void 0===container?$("#poll-results-container"):$(container),void 0===showModal&&(showModal=!0),void 0===toggleBlock&&(toggleBlock=!1),console.log("toggleBlock: "+toggleBlock),requestHandler.ajaxRequest("/api/forum/getPollResults",{tid:TopicGuest.id},function(response){container.empty(),$(response).each(function(){total=void 0===this.total?0:this.total,percentage=void 0===this.percentage?0:this.percentage;var str='<li class="poll-result">';str+='<div class="voted-icon-cell"></div>',str+='<h3 class="option-text">',str+=this.name,str+="</h3>",str+='<div class="bar-cell">',str+='<span class="bar-container">',str+='<span class="bar" style="width: '+percentage+'%"></span>',str+="</span>",str+="</div>",str+='<div class="count">',str+=total+" голосов",str+="</div>",str+='<div class="percentage">',str+=percentage+"%",str+="</div>",str+="</li>",container.append(str)}),""!==toggleBlock&&("results"===toggleBlock&&($("#poll-variants-block").hide(),$("#poll-vote-btn").hide(),$("#poll-results-btn").hide(),$("#poll-revote-btn-ajax").show(),$("#poll-revote-btn").show(),$("#poll-results").show()),"revote"===toggleBlock&&Topic.toggleRevoteBlock()),showModal&&$("#poll-resultsModal").modal("show")})},pollVote:function(){var value=null;Topic.poll_multiple?(value=[],$("#poll-variants").find("input:checked").each(function(){value.push(this.value)})):value=$("input[name=poll-response]:checked","#poll-form").val();var btn=$("#poll-vote-btn");if(void 0===value||0===value.length)return Utils.notify("Вы не выбрали вариант голосования","warning");btn.button("loading"),requestHandler.ajaxRequest("/api/forum/votePoll",{pid:Topic.id,variant:value},function(response){switch(btn.button("reset"),response.status){case"success":Utils.notify("Вы успешно проголосовали в данном опросе","success",3e3),$("#poll-vote-btn").hide(),Topic.loadPollResults("#poll-results",!1,"results"),Topic.markPollVote(value);break;case"userNotActivated":Utils.notify("Пользователь не активирован","warning");break;case"empty":Utils.notify("Вы не выбрали вариант","warning");break;case"alreadyVoted":Utils.notify("Вы уже голосовали","warning",5e3);break;case"invalidPoll":Utils.notify("Некорректный опрос","warning",6e3);break;case"invalidPollVoteType":Utils.notify("Некорректный тип ответа","warning",6e3);break;case"invalidVariant":Utils.notify("Некорректный один с вариантов ответа","warning",6e3)}})},markPollVote:function(variant){var pollVariants=$("#poll-variants");if(pollVariants.find("b").remove(),variant.constructor===Array)for(var i=0;i<variant.length;i++){var el2=pollVariants.find("input[value="+variant[i]+"]").parent().find("span").first();el2.html("<b>* </b>"+el2.html())}else{var el=pollVariants.find("input[value="+variant+"]").parent().find("span").first();el.html("<b>* </b>"+el.html())}},revotePoll:function(){var value=null;if(Topic.poll_multiple){if(value=[],$("#poll-variants").find("input:checked").each(function(){value.push(this.value)}),0===value.length)return Utils.notify("Вы не выбрали ни одного варианта","warning",5e3)}else value=$("input[name=poll-response]:checked","#poll-form").val();var btn=$("#poll-revote-btn");if(void 0===value)return Utils.notify("Вы не выбрали вариант голосования","warning");btn.button("loading"),requestHandler.ajaxRequest("/api/forum/revotePoll",{pid:Topic.id,variant:value},function(response){switch(btn.button("reset"),response.status){case"success":Utils.notify("Вы успешно переголосовали в данном опросе","success",3e3),Topic.loadPollResults("#poll-results",!1,"revote"),Topic.markPollVote(value);break;case"userNotActivated":Utils.notify("Пользователь не активирован","warning");break;case"notVoted":Utils.notify("Вы не голосовали в данном опросе","warning",5e3);break;case"invalidPoll":Utils.notify("Некорректный опрос","warning",6e3);break;case"invalidPollVoteType":Utils.notify("Некорректный тип ответа","warning",6e3);break;case"empty":Utils.notify("Вы не выбрали ни одного варианта","warning",5e3);break;case"invalidVariant":Utils.notify("Некорректный один с вариантов ответа","warning",6e3)}})},toggleRevoteBlock:function(){var variantsBlock=$("#poll-variants-block"),resultBlock=$("#poll-results-block"),cancelBtn=$("#poll-revote-toggle-btn");variantsBlock.is(":visible")?(Utils.animateOnce("#poll-variants-block","fadeOutLeft"),Utils.animateOnce("#poll-results-block","fadeInLeft"),variantsBlock.hide(),resultBlock.show(),cancelBtn.hide()):(Utils.animateOnce("#poll-results-block","fadeOutLeft"),Utils.animateOnce("#poll-variants-block","fadeInLeft"),resultBlock.hide(),variantsBlock.show(),cancelBtn.show())},quotePost:function(id,username,uid){var quoteContent=Forum.getBBCode(id,!1);this._LOGGER.debug("quotePost quoteContent: "+quoteContent+" username: "+username);var html='<p>[QUOTE="'+Utils.escapeHTML(username)+", post: "+id+", member: "+uid+'"]</p>'+quoteContent.trim()+"<p>[/QUOTE]</p>";html+="<br>",app.insertRedactorContent(html),$("html").scrollTo(".quick-reply")},ratePost:function(pid,el){var smileWindow=$(".phone_wrapper"),_this=$(el),btnPos=_this.offset();$(".phone_wrapper header nav a:first-child").attr("data-catid");$.btn=_this,$.pid=pid,smileWindow.fadeToggle(350),$("#rate-pId").text(pid),smileWindow.offset({top:btnPos.top-480,left:btnPos.left/1.5}),smileWindow.visible()||smileWindow.offset({top:btnPos.top+20,left:btnPos.left/1.5}),this.getPopularUsedSmiles(0)},getTopUsedSmiles:function(tab_id){var block=$(".phone_wrapper main .tab_reel .tab_panel");$(".phone_wrapper header nav .tab.active").removeClass("active"),$(".phone_wrapper header nav .tab.tab"+tab_id).addClass("active"),block.html(""),requestHandler.ajaxRequest("/api/forum/getTopUsedSmiles",{},function(response){if(response){if(response.length<=0)return block.html(""),block.fadeIn(600),void block.append('<span style="position: absolute;left:10px;right:10px;text-align:center;">Не найдено смайлов которые входят в ТОП10.</span>');block.fadeOut(0);var panelContent="";$.each(response,function(i,row){panelContent+='<div style="display: inline-block;margin:3px;">',panelContent+='<a href="javascript:Topic.setPostRate('+$.pid+","+row.smile_id+')" title="'+row["smile.title"]+'"><img src="/img/forum/emoticons/'+row["smile.url"]+'" style="max-height: 50px;max-width: 50px;white-space: unset!important;" role="presentation" /></a>',panelContent+="</div>"}),block.append(panelContent),block.fadeIn(400)}})},getOftenUsedSmiles:function(tab_id){var block=$(".phone_wrapper main .tab_reel .tab_panel");$(".phone_wrapper header nav .tab.active").removeClass("active"),$(".phone_wrapper header nav .tab.tab"+tab_id).addClass("active"),block.html(""),requestHandler.ajaxRequest("/api/forum/getOftenUsedSmiles",{},function(response){if(response){if(response.length<=0)return block.html(""),block.fadeIn(600),void block.append('<span style="position: absolute;left:10px;right:10px;text-align:center;">На данный момент у Вас отсутствуют часто используемые смайлы.</span>');block.fadeOut(0);var panelContent="";$.each(response,function(i,row){panelContent+='<div style="display: inline-block;margin:3px;">',panelContent+='<a href="javascript:Topic.setPostRate('+$.pid+","+row.smile_id+')" title="'+row["smile.title"]+'"><img src="/img/forum/emoticons/'+row["smile.url"]+'" style="max-height: 50px;max-width: 50px;white-space: unset!important;" role="presentation" /></a>',panelContent+="</div>"}),block.append(panelContent),block.fadeIn(400)}})},getPopularUsedSmiles:function(tab_id){var block=$(".phone_wrapper main .tab_reel .tab_panel");$(".phone_wrapper header nav .tab.active").removeClass("active"),$(".phone_wrapper header nav .tab.tab"+tab_id).addClass("active"),block.html(""),requestHandler.ajaxRequest("/api/forum/getPopularUsedSmiles",{},function(response){if(response){if(response.length<=0)return block.html(""),block.fadeIn(600),void block.append('<span style="position: absolute;left:10px;right:10px;text-align:center;">На данный момент у Вас отсутствуют часто используемые смайлы.</span>');block.fadeOut(0);var panelTopContent="",panleOftenContent="";panelTopContent='<h3 style="text-align: center; margin: .5em;">Самые популярные на форуме</h3>',$.each(response.top_smiles,function(i,row){panelTopContent+='<div style="display: inline-block;margin:3px;">',panelTopContent+='<a href="javascript:Topic.setPostRate('+$.pid+","+row.smile_id+')" title="'+row["smile.title"]+'"><img src="/img/forum/emoticons/'+row["smile.url"]+'" style="max-height: 50px;max-width: 50px;white-space: unset!important;" role="presentation" /></a>',panelTopContent+="</div>"}),panleOftenContent='<h3 style="text-align: center; margin: .5em;">Часто используемые вами</h3>',$.each(response.often_smiles,function(i,row){panleOftenContent+='<div style="display: inline-block;margin:3px;">',panleOftenContent+='<a href="javascript:Topic.setPostRate('+$.pid+","+row.smile_id+')" title="'+row["smile.title"]+'"><img src="/img/forum/emoticons/'+row["smile.url"]+'" style="max-height: 50px;max-width: 50px;white-space: unset!important;" role="presentation" /></a>',panleOftenContent+="</div>"}),block.append(panelTopContent),block.append(panleOftenContent),block.fadeIn(400)}})},getSmilesForRateByCategory:function(cat_id,tab_id){var block=$(".phone_wrapper main .tab_reel .tab_panel");$(".phone_wrapper header nav .tab.active").removeClass("active"),$(".phone_wrapper header nav .tab.tab"+tab_id).addClass("active"),block.html(""),requestHandler.ajaxRequest("/api/forum/getSmiles",{cat_id:parseInt(cat_id)},function(response){if(response){block.fadeOut(0);var panelContent="";$.each(response,function(i,row){row.id===cat_id&&$.each(row.smiles,function(i,icon){panelContent+='<div style="display: inline-block;margin:3px;">',panelContent+='<a href="javascript:Topic.setPostRate('+$.pid+","+icon.id+')" title="'+icon.title+'"><img src="'+icon.url+'" style="max-height: 50px;max-width: 50px;white-space: unset!important;" role="presentation" /></a>',panelContent+="</div>"})}),block.append(panelContent),block.fadeIn(400)}})},setPostRate:function(pid,smile_id){var tokenHash=$("#csrf_input").val();requestHandler.ajaxRequest("/api/forum/setPostRate",{pid:parseInt(pid),smileId:parseInt(smile_id),token:tokenHash},function(response){switch(null!=response.status.restriction&&0<response.status.restriction.length&&Utils.notify(response.status.restriction,"warning",3e3),response.status){case"success":Utils.notify("Вы оценили данный пост","warning",3e3);var smilesBlock=$("#post-rated-list-"+pid+" .post-smiles-content ul"),sameSmileBlock=$("#post-rated-list-"+pid+" .post-smiles-content ul a li.smile-"+smile_id),smilePos=response.smile_pos,style="";if(1==smilePos?style="rate-like-bottom-color":2==smilePos&&(style="rate-dislike-bottom-color"),0<sameSmileBlock.find(".smiles-count").length)sameSmileBlock.addClass("post-rated-user"),sameSmileBlock.parent().attr("href","javascript:Topic.unRatePost("+pid+","+smile_id+")"),sameSmileBlock.find(".smiles-count").text(response.smiles_common_count);else{var timestamp=response.smile_timestamp?"?"+response.smile_timestamp:"";1!=smilePos&&2!=smilePos?(smilesBlock.parent().css("border-top","1px solid rgba(255,255,255,.1)"),sameSmileBlock.parent().remove(),smilesBlock.find(".rate-btn-plus").before('<a href="javascript:Topic.unRatePost('+pid+","+smile_id+')"><li class="'+style+" post-rated-user smile-"+smile_id+'"><img src="/img/forum/emoticons/'+response.smile_url+timestamp+'" title="'+response.smile_title+'"><span class="smiles-count">1</span></li></a>')):(sameSmileBlock.addClass("post-rated-user"),sameSmileBlock.parent().attr("href","javascript:Topic.unRatePost("+pid+","+smile_id+")"),sameSmileBlock.append('<span class="smiles-count">1</span>'),sameSmileBlock.find(".smiles-count").text(response.smiles_common_count))}$(".phone_wrapper").fadeOut(200),$(".default-rate.p-"+pid+".s-"+smile_id).css("opacity","1");break;case"alreadyRated":Utils.notify("Вы уже оценивали этот пост ранее","warning",3e3);break;case"tooManySmiles":Utils.notify("Превышен лимит разных оценок для поста","warning",4e3);break;case"invalidPost":Utils.notify("Некорректный пост","warning",6e3);break;case"self":Utils.notify("Вы не можете оценивать свои записи","info",5e3);break;case"invalidSmile":Utils.notify("Смайл не найден в нашей базе, пожалуйста, выберите другой.","warning",6e3);break;case"throttle":Utils.notify("Нельзя оценивать сообщения так часто<br>Подождите 5 секунд","warning",3e3);break;case"same_rate_throttle":Utils.notify("Нельзя ставить одинаковые оценки одному пользователю так часто","warning",3e3)}})},unRatePost:function(pid,smile_id){requestHandler.ajaxRequest("/api/forum/unRatePost",{pid:parseInt(pid),smileId:parseInt(smile_id)},function(response){switch(response.status){case"success":var sameSmileBlock=$("#post-rated-list-"+pid+" .post-smiles-content ul a li.post-rated-user.smile-"+smile_id),smilePos=response.smile_pos;sameSmileBlock.find(".smiles-count").text(response.smiles_common_count),sameSmileBlock.parent().attr("href","javascript:Topic.setPostRate("+pid+","+smile_id+")"),sameSmileBlock.removeClass("post-rated-user"),1!=smilePos&&2!=smilePos?(response.smiles_common_count<1||null===response.smiles_common_count)&&(sameSmileBlock.parent().remove(),$("#post-rated-list-"+pid+" .post-smiles-content").css("border-top","0")):(response.smiles_common_count<1||null===response.smiles_common_count)&&sameSmileBlock.find(".smiles-count").remove();break;case"invalidPost":Utils.notify("Некорректный пост","warning",6e3);break;case"invalidSmile":Utils.notify("Смайл не найден в нашей базе, пожалуйста, выберите другой.","warning",6e3)}})},showPostRates:function(){alert(1)},closeSmilesWindow:function(){$(".phone_wrapper").hide()},likePost:function(id){var likesContainer=$("#post-likes-"+id),likesContent=$("#post-likes-content-"+id),likeBtn=$("#like-btn-"+id),container=null;requestHandler.ajaxRequest("/api/forum/likePost",{pid:id},function(response){switch(response.status){case"success":likesContainer.is(":visible")||likesContainer.show(),"SPAN"===(container=$("#"+id+"-like-"+Utils.user_id).prev()).prop("nodeName")&&container.remove(),likesContainer.find(".liked-by-me").is(":visible")?(Topic._LOGGER.debug("[post] dislike"),likeBtn.html('<i class="fa fa-fw fa-thumbs-up"></i> Мне нравится'),likesContainer.find(".liked-by-me").hide(),likesContainer.find(".liked-by-me-and").hide(),0===likesContent.find("a").length?likesContainer.hide():likesContainer.find(".likes-that-end").show()):(Topic._LOGGER.debug("[post] like"),likeBtn.html('<i class="fa fa-fw fa-thumbs-down"></i> Не нравится'),likesContainer.find(".likes-that-end").hide(),lastLike=likesContainer.find("a").first(),void 0!==lastLike&&0<lastLike.length?(likesContainer.find(".liked-by-me").show(),likesContainer.find(".liked-by-me-and").show()):(likesContainer.find(".liked-by-me").show(),likesContainer.find(".liked-by-me-and").hide()));break;case"self":Utils.notify("Вы не можете оценивать свои записи","info",5e3);break;case"userNotActivated":Utils.notify("Пользователь не активирован","warning");break;case"throttle":Utils.notify("Нельзя лайкать сообщения так часто<br>Подождите 5 секунд","warning",3e3);break;case"hack":Utils.notify("Функция недоступна","warning",3e3);break;case"invalidPost":Utils.notify("Некорректный пост","warning",6e3)}})},abusePost:function(id){this._post_id=id,Topic.clearAbuseDesc(),$("#abuse-post-id").html(this._post_id),$("#abuse-post-href").attr("href","posts/"+this._post_id+"/"),$("#abusePostModal").modal("show"),$("#abuse-description").focus()},clearAbuseDesc:function(){$("#abuse-description").html(""),$("#abuse-description").val("")},sendAbuse:function(rules){rules=void 0!==rules;var btn=$("#sendAbuseBtn"),description=$("#abuse-description").val();if(rules&&"none"==$("#abuse-rules").val())return Utils.notify("Вы не выбрали правило","warning");if(description.trim().length<1)return Utils.notify("Вы не ввели содержимое жалобы","warning");btn.button("loading"),requestHandler.ajaxRequest("/api/forum/sendCustomAbuse",{type:"post",pid:this._post_id,description:description.trim()},function(response){switch(btn.button("reset"),response.status){case"success":$("#abuse-description").html(""),$("#abuse-description").val(""),$("#abusePostModal").modal("hide"),Utils.notify("Жалоба успешно отправлена<br>В скором времени она будет рассмотрена","success",5e3);break;case"throttle":Utils.notify("Вы уже отправили жалобу по этому сообщению","warning");break;case"invalidPost":Utils.notify("Некорректное сообщение<br>Возможно оно было удалено","warning",6e3);break;case"specifyDescription":Utils.notify("Вы не ввели содержимое жалобы","warning",6e3);break;case"immunity":Utils.notify("Нельзя отправлять жалобы на администрацию","warning",5e3)}})},openPostEditor:function(id){var container=$("#message-container-"+id),messageContent=$("#message-content-"+id),editContainer=$("#message-edit-"+id),buttonSave=$("#message-save-btn-"+id),buttonNotify=$("#message-alert-btn-"+id),buttonFullEdit=$("#message-fulledit-btn-"+id),buttonClose=$("#message-close-btn-"+id);Topic.isEditorActive(id)||(editContainer.show(),app.redactor("#message-edit-"+id,null,Forum.getBBCode(id),!0),messageContent.hide(),buttonSave.show(),buttonFullEdit.show(),buttonClose.show(),(Utils.isAdmin||Utils.isGlobalModerator||Utils.isSuperModerator)&&0<buttonSave.length?buttonNotify.show():buttonNotify.hide(),$("html, body").animate({scrollTop:container.offset().top},500),container.focus())},isEditorActive:function(id){return!$("#message-content-"+id).is(":visible")},closePostEditor:function(id){var buttonSave=$("#message-save-btn-"+id),buttonFullEdit=$("#message-fulledit-btn-"+id),buttonClose=$("#message-close-btn-"+id),buttonNotify=$("#message-alert-btn-"+id),editContainer=$("#message-edit-"+id),messageContent=$("#message-content-"+id);app.destroyRedactor("message-edit-"+id),buttonSave.hide(),buttonFullEdit.hide(),buttonClose.hide(),editContainer.hide(),messageContent.show(),0<buttonNotify.length&&(buttonNotify.find("i").first().removeClass("fa-plus").removeClass("text-info").addClass("fa-minus"),buttonNotify.attr("title","Уведомление не будет отправлено"),buttonNotify.hide(),Topic.cancelNotifyUserAfterEdit(),"undefined"!=typeof notifyPostId&&(notifyPostId=null))},cancelNotifyUserAfterEdit:function(){Warn.AlertAfter.post_id=null,Warn.AlertAfter.rule_id=null,Warn.AlertAfter.title=null,Warn.AlertAfter.text=null,Warn.AlertAfter.comment=null},editPost:function(id){var div=$("#message-edit-"+id),content=$("#message-content-"+id),bbcodeContent=$("#message-content-bbcode-"+id),buttonSave=$("#message-save-btn-"+id),buttonFullEdit=$("#message-fulledit-btn-"+id),buttonClose=$("#message-close-btn-"+id),buttonNotify=$("#message-alert-btn-"+id),notify=null;if((Utils.isSuperModerator||Utils.isGlobalModerator||Utils.isAdmin)&&"undefined"!=typeof Warn&&void 0!==Warn.AlertAfter&&Warn.AlertAfter.post_id==id&&(console.log("editPost Attaching notification."),notify=Warn.AlertAfter),0===app.getRedactorContent("message-edit-"+id).trim().length)return Utils.notify("Нельзя сохранить пустое сообщение","warning",4500);var val=app.getRedactorContent("message-edit-"+id).trim();buttonSave.button("loading"),requestHandler.ajaxRequest("/api/forum/editForumPost",{message:id,content:val,notification:notify},function(response){switch(buttonSave.button("reset"),response.status){case"success":content.show(),response.content_parsed&&content.html(Base64.decode(response.content_parsed)),buttonSave.hide(),buttonFullEdit.hide(),buttonClose.hide(),bbcodeContent.html(val),div.html(val),app.destroyRedactor("message-edit-"+id),div.hide(),Topic.setEditTime(response.post_id,response.date_edited),response.notification_sent?Utils.notify("Сообщение успешно изменено<br>Пользователю отправлено уведомление","success"):Utils.notify("Сообщение успешно изменено","success"),response.notification_sent&&(notifyPostId=null,Topic.cancelNotifyUserAfterEdit()),0<buttonNotify.length&&(buttonNotify.find("i").first().removeClass("fa-plus").removeClass("text-info").addClass("fa-minus"),buttonNotify.attr("title","Уведомление не будет отправлено"),buttonNotify.hide()),Warn.AlertAfter.post_id=null,Warn.AlertAfter.rule_id=null,Warn.AlertAfter.title=null,Warn.AlertAfter.text=null,Warn.AlertAfter.comment=null;break;case"userNotActivated":Utils.notify("Пользователь не активирован","warning");break;case"moderation":content.show(),buttonSave.hide(),buttonFullEdit.hide(),buttonClose.hide(),app.destroyRedactor("message-edit-"+id),div.hide(),Utils.notify("Ваша правка отправлена на премодерацию","info",5e3),0<buttonNotify.length&&(buttonNotify.find("i").first().removeClass("fa-plus").removeClass("text-info").addClass("fa-minus"),buttonNotify.attr("title","Уведомление не будет отправлено"),buttonNotify.hide()),Warn.AlertAfter.post_id=null,Warn.AlertAfter.rule_id=null,Warn.AlertAfter.title=null,Warn.AlertAfter.text=null,Warn.AlertAfter.comment=null;break;case"same":content.show(),buttonSave.hide(),buttonFullEdit.hide(),buttonClose.hide(),app.destroyRedactor("message-edit-"+id),div.hide(),Utils.notify("Сообщение успешно изменено","success");break;case"imgLimit":Utils.notify("Превышено количество допустимых картинок<br>Лимит: "+response.limit,"warning",4e3);break;case"iframeLimit":Utils.notify("Превышено количество допустимых видео<br>Лимит: "+response.limit,"warning",4e3);break;case"iframeResize":Utils.notify("Ширина или высота вставляемого объекта недопустима<br>Максимальное значение: "+response.width+"x"+response.height,"warning",4e3);break;case"imgResize":Utils.notify("Ширина или высота вставляемой картинки недопустима<br>Максимальное значение: "+response.width+"x"+response.height,"warning",4e3);break;case"smilesLimit":Utils.notify("Достигнут лимит смайликов<br>Максимум: "+response.limit,"warning",4e3);break;case"length":Utils.notify("Некорректная длина сообщения<br>Максимально допустимое кол. символов: "+Utils.config.post.charLimit,"warning",5e3);break;case"invalidTopic":Utils.notify("Некорректная тема<br>Возможно она была закрыта или удалена","warning",6e3);break;case"closedTopic":Utils.notify("Данная тема закрыта для изменений","warning",6e3);break;default:buttonSave.button("reset")}})},setEditTime:function(postid,time){var post=$("#post-"+postid),timestamp=Math.floor(Date.now()/1e3);if(this._LOGGER.debug("[post] setEditTime post timestamp: "+time+", timestamp global: "+timestamp),timestamp<time-300){var block=post.find(".post-edit-time time").first();block.parent().show(),block.data("time",time),app.checkTime()}},reply:function(){Logger.time("Topic reply");var div=app.getRedactorContent("forumPost"),buttonSave=$("#send-message");if(0===div.trim().length)return Utils.notify("Нельзя отправить пустое сообщение","warning",4500);buttonSave.button("loading"),Topic.current_page===Topic.pages?requestHandler.ajaxRequest("/api/forum/getPostsAfter",{pid:Topic.last_post_id},function(response){var loadLimit=parseInt(Utils.config.post.limitPostsAfterLoad);switch(response.status){case"success":if(0!==response.count){$("#newTopicPostsLimit").remove(),$("#newTopicPosts").remove();var el=null;if(!(response.count<=loadLimit))return Topic._LOGGER.debug("getPostsAfter Loaded more than limit ("+loadLimit+"): "+response.count),$("#newTopicPosts").hide(),Topic.getLastPost().after('<li><div id="newTopicPostsLimit" class="thread-alert secondary-content" style="display: none"><h4><span style="color: #f04124">В теме появились новые сообщения.</span> Посмотреть <a style="color: #54a8d4" id="lastTopicPostLink" href="">все</a>?</h4></div></li>'),(el=$("#newTopicPostsLimit")).show(),Utils.animateOnce("#newTopicPostsLimit","pulse"),$("#lastTopicPostLink").attr("href","threads/"+Topic.link+"/?action=unread"),void Topic.submitMessage();Topic.getLastPost().after('<li><div id="newTopicPosts" class="thread-alert secondary-content" style="display: none"><h4 style="color: #f04124">В теме появились новые сообщения.</h4></div></li>'),$("#newTopicPostsLimit").hide(),(el=$("#newTopicPosts")).show(),Utils.animateOnce("#newTopicPosts","pulse"),Topic.submitMessage(),Topic.addDOMPost(response),$("html, body").animate({scrollTop:el.offset().top},100)}else Topic.submitMessage();break;case"invalidRequest":console.warn("[post] getPostsAfter returned invalidRequest! Skipping..."),Topic.submitMessage()}}):Topic.submitMessage(),Logger.timeEnd("Topic reply")},submitMessage:function(){Logger.time("Post submit");var div=app.getRedactorContent("forumPost"),buttonSave=$("#send-message");if(Topic.checkBeforeSubmit(div)){if(0===div.trim().length)return buttonSave.button("reset"),Utils.notify("Нельзя отправить пустое сообщение","warning",4500);buttonSave.button("loading"),requestHandler.ajaxRequest("/api/forum/replyToTopic",{topic:Topic.id,content:div},function(response){switch(buttonSave.button("reset"),Logger.timeEnd("Post submit"),response.status){case"unauthorized":loginPopup();break;case"success":Topic.last_post_id=response.data.id,Topic._LOGGER.debug("[topic] Post submitted. Last post is "+Topic.last_post_id+" ("+response.data.id+")"),app.setRedactorContent(" "),1<Topic.pages&&Topic.current_page!==Topic.pages?location.href="/"+Utils.prefix+response.page:(Utils.notify("Сообщение успешно отправлено","success"),Topic.addDOMPost(response.data),$("#newTopicPostsLimit").remove(),$("#newTopicPosts").remove());break;case"moderation":app.setRedactorContent(" "),Utils.notify("Ваше сообщение отправлено на премодерацию","info",5e3);break;case"imgLimit":Utils.notify("Превышено количество допустимых картинок<br>Лимит: "+response.limit,"warning",4e3);break;case"iframeLimit":Utils.notify("Превышено количество допустимых видео<br>Лимит: "+response.limit,"warning",4e3);break;case"iframeResize":Utils.notify("Ширина или высота вставляемого объекта недопустима<br>Максимальное значение: "+response.width+"x"+response.height,"warning",4e3);break;case"imgResize":Utils.notify("Ширина или высота вставляемой картинки недопустима<br>Максимальное значение: "+response.width+"x"+response.height,"warning",4e3);break;case"smilesLimit":Utils.notify("Достигнут лимит смайликов<br>Максимум: "+response.limit,"warning",4e3);break;case"merged":if(app.setRedactorContent(" "),1<Topic.pages&&Topic.current_page!==Topic.pages)location.href=response.page;else $("#message-content-"+response.postId).html(Base64.decode(response.content)),Topic.setEditTime(response.postId,response.date_edited),location.hash="post-"+response.postId,Utils.animateOnce("#post-"+response.postId,"pulse");break;case"userNotActivated":Utils.notify("Пользователь не активирован","warning");break;case"length":Utils.notify("Некорректная длина сообщения<br>Максимально допустимое кол. символов: "+Utils.config.post.charLimit,"warning",5e3);break;case"empty":Utils.notify("Нельзя отправить пустое сообщение","warning",4500);break;case"invalidTopic":Utils.notify("Некорректная тема<br>Возможно она была закрыта или удалена","warning",6e3);break;case"throttle":void 0!==response.message?Utils.notify(response.message.replace("\n","<br>"),"warning",4e3):Utils.notify("Нельзя отправить второе сообщение<br>Используйте редактирование","warning",4e3);break;case"closedTopic":Utils.notify("Данная тема закрыта для изменений","warning",6e3);break;case"accessDenied":break;default:Utils.notify("Произошла ошибка<br>Код: "+Base64.encode(JSON.stringify(response)),"error",8e3)}})}else buttonSave.button("reset")},checkBeforeSubmit:function(html){var $doc=$(html),smilesCount=$doc.find('[data-smile="1"]').length;return smilesCount>Utils.config.post.smilesLimit?(this._LOGGER.debug("[post] Smiles limit reached. Current: "+smilesCount+" Limit: "+Utils.config.post.smilesLimit),Utils.notify("Слишком много смайликов<br>Максимум "+Utils.config.post.smilesLimit,"warning")):$doc.find('img[data-smile!="1"]').length>Utils.config.post.imgLimit?(this._LOGGER.debug("[post] Images limit reached. Current: "+$doc.find("img").length+" Limit: "+Utils.config.post.imgLimit),Utils.notify("Слишком много изображений<br>Максимум "+Utils.config.post.imgLimit,"warning")):!($doc.find("iframe").length>Utils.config.post.iframeLimit)||(this._LOGGER.debug("[post] Iframe limit reached. Current: "+$doc.find("iframe").length+" Limit: "+Utils.config.post.iframeLimit),Utils.notify("Слишком много медиа контента<br>Максимум "+Utils.config.post.iframeLimit,"warning"))}};Topic.init();
//# sourceMappingURL=topic-view.min.js.map